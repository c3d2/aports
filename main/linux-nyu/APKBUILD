# Maintainer: Nero <nero@w1r3.net>

_flavor=nyu
pkgname=linux-${_flavor}
pkgver=4.9.77
case $pkgver in
	*.*.*)	_kernver=${pkgver%.*};;
	*.*) _kernver=$pkgver;;
esac
pkgrel=1
pkgdesc="Linux kernel, ${_flavor} flavor"
url="http://kernel.org"
makedepends="perl sed installkernel bash gmp-dev bc linux-headers elfutils-dev linux-firmware-intel libressl-dev"
options="!strip !check"
_config=${config:-config-${_flavor}.${CARCH}}
install=
source="https://cdn.kernel.org/pub/linux/kernel/v${pkgver%%.*}.x/linux-$_kernver.tar.xz
	${_config}

	"
if [ "${pkgver%.0}" = "$pkgver" ]; then
	source="$source
	https://cdn.kernel.org/pub/linux/kernel/v${pkgver%%.*}.x/patch-$pkgver.xz"
fi
arch="x86_64"
license="GPL2"

_abi_release=${pkgver}
_carch=${CARCH}

HOSTCC="${CC:-gcc}"
HOSTCC="${HOSTCC#${CROSS_COMPILE}}"

prepare() {
	local _patch_failed=
	cd "$srcdir"/linux-$_kernver
	if [ "$_kernver" != "$pkgver" ]; then
		msg "Applying patch-$pkgver.xz"
		unxz -c < "$srcdir"/patch-$pkgver.xz | patch -p1 -N || return 1
	fi

	# first apply patches in specified order
	for i in $source; do
		case $i in
		*.patch)
			msg "Applying $i..."
			if ! patch -s -p1 -N -i "$srcdir"/$i; then
				echo $i >>failed
				_patch_failed=1
			fi
			;;
		esac
	done

	if ! [ -z "$_patch_failed" ]; then
		error "The following patches failed:"
		cat failed
		return 1
	fi

	mkdir -p "$srcdir"/build
	cp "$srcdir"/$_config "$srcdir"/build/.config || return 1
	make -C "$srcdir"/linux-$_kernver O="$srcdir"/build ARCH="$_carch" HOSTCC="$HOSTCC" \
		silentoldconfig
}

# this is so we can do: 'abuild menuconfig' to reconfigure kernel
menuconfig() {
	cd "$srcdir"/build || return 1
	make ARCH="$_carch" menuconfig
	cp .config "$startdir"/$_config
}

build() {
	cd "$srcdir"/build
	unset LDFLAGS
	make ARCH="$_carch" CC="${CC:-gcc}" \
		KBUILD_BUILD_VERSION="$((pkgrel + 1 ))-Alpine" \
		|| return 1
}

package() {
	cd "$srcdir"/build

	mkdir -p "$pkgdir"/boot

	make -j1 install \
		ARCH="$_carch" \
		INSTALL_PATH="$pkgdir"/boot \
		|| return 1
}

sha512sums="bf67ff812cc3cb7e5059e82cc5db0d9a7c5637f7ed9a42e4730c715bf7047c81ed3a571225f92a33ef0b6d65f35595bc32d773356646df2627da55e9bc7f1f1a  linux-4.9.tar.xz
4330324d5ee0a2a6a2f6cae977e138752103b527e18d24b059f637b131d8afaecaf0d242fd5749b77bb6f2c3fc7431d793cd9c67fb4f1d7c382ba4d478592f66  config-nyu.x86_64
87cbb29ecd87b5e3e8f06eb5afe6f313f7bb36933a05d8e3f185a7cb96b6cd0e69fc1eab9bf78d20a8671651da5a9a6c062797d3ed6c86258cc74335027453d6  patch-4.9.77.xz"
